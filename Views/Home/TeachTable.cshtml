@using SchoolSystem.Models.ViewModels;
@model IEnumerable<SchoolSystem.Models.ViewModels.TeachingScheduleViewModel>
@{
    ViewBag.Title = "ตารางสอนของอาจารย์";
    var daysOfWeek = new[] { "จันทร์", "อังคาร", "พุธ", "พฤหัสบดี", "ศุกร์", "เสาร์", "อาทิตย์" };

    // กำหนดคาบเรียน
    var periods = new[]
    {
        (Name: "คาบ 1", Start: new TimeSpan(8, 0, 0), End: new TimeSpan(9, 20, 0)),
        (Name: "คาบ 2", Start: new TimeSpan(9, 20, 0), End: new TimeSpan(10, 10, 0)),
        (Name: "คาบ 3", Start: new TimeSpan(10, 10, 0), End: new TimeSpan(11, 0, 0)),
        (Name: "คาบ 4", Start: new TimeSpan(11, 0, 0), End: new TimeSpan(12, 0, 0)),
        (Name: "คาบ 5", Start: new TimeSpan(12, 0, 0), End: new TimeSpan(12, 50, 0)),
        (Name: "คาบ 6", Start: new TimeSpan(13, 50, 0), End: new TimeSpan(14, 40, 0)),
        (Name: "ติวเสริม", Start: new TimeSpan(14, 40, 0), End: new TimeSpan(16, 0, 0))
    };

    // ก่อนใช้งาน ต้องตรวจสอบว่ามีข้อมูลหรือไม่
    var scheduleByDay = new Dictionary<string, List<TeachingScheduleViewModel>>();

    if (Model != null && Model.Any())
    {
        // จัดกลุ่มข้อมูลตามวันและเวลา
        scheduleByDay = Model.GroupBy(s => s.DayOfWeek)
                             .ToDictionary(g => g.Key, g => g.ToList());
    }

    // ฟังก์ชั่นสำหรับแปลงเวลาเป็นข้อความ
    string FormatTimeDisplay(TimeSpan time)
    {
        try
        {
            return $"{time.Hours:00}:{time.Minutes:00}";
        }
        catch
        {
            return "--:--";
        }
    }

    // ฟังก์ชั่นตรวจสอบว่าคาบเรียนอยู่ในช่วงเวลาที่กำหนดหรือไม่
    List<TeachingScheduleViewModel> GetSchedulesForPeriod(string day, TimeSpan periodStart, TimeSpan periodEnd)
    {
        List<TeachingScheduleViewModel> result = new List<TeachingScheduleViewModel>();

        if (!scheduleByDay.ContainsKey(day))
            return result;

        foreach (var schedule in scheduleByDay[day])
        {
            // ตรวจสอบว่าคาบเรียนทับกับช่วงเวลาที่กำหนดหรือไม่
            bool overlaps =
                (schedule.StartTime <= periodEnd && schedule.EndTime >= periodStart) || // คาบเรียนครอบคลุมช่วงเวลา
                (schedule.StartTime >= periodStart && schedule.StartTime < periodEnd) || // เริ่มอยู่ในช่วงเวลา
                (schedule.EndTime > periodStart && schedule.EndTime <= periodEnd);       // จบอยู่ในช่วงเวลา

            if (overlaps)
            {
                result.Add(schedule);
            }
        }

        return result;
    }
}

<div class="bg-yellow-50 min-h-screen p-6">
    <div class="max-w-7xl mx-auto">
        <div class="mb-6 bg-white rounded-lg shadow p-4">
            <h2 class="text-2xl font-bold text-indigo-800 mb-2">@ViewBag.Title</h2>
            <div class="text-sm text-gray-600 mb-2">
                @if (Model != null && Model.Any())
                {
                    var firstSchedule = Model.First();
                    <p>ภาคการศึกษาที่ @firstSchedule.SemesterNumber ปีการศึกษา @firstSchedule.SemesterYear</p>
                }
                else
                {
                    <p>ไม่พบข้อมูลตารางสอน</p>
                }
            </div>
        </div>

        <!-- ตารางสอนตามคาบเรียน -->
        <div class="overflow-auto bg-white rounded-lg shadow mb-8">
            <table class="min-w-full border border-collapse border-gray-300">
                <!-- หัวตาราง -->
                <thead>
                    <tr class="bg-gray-100">
                        <th rowspan="2" class="border border-gray-300 p-2 text-center font-medium text-gray-700">
                            วัน / เวลา
                        </th>
                        @foreach (var period in periods)
                        {
                            <th class="border border-gray-300 p-2 text-center font-medium text-gray-700">
                                @period.Name
                            </th>
                        }
                    </tr>
                    <tr class="bg-gray-50">
                        @foreach (var period in periods)
                        {
                            <th class="border border-gray-300 p-1 text-center text-xs text-gray-500">
                                @FormatTimeDisplay(period.Start) - @FormatTimeDisplay(period.End)
                            </th>
                        }
                    </tr>
                </thead>
                <tbody>
                    @foreach (var day in daysOfWeek)
                    {
                        <tr>
                            <td class="border border-gray-300 bg-gray-50 p-2 text-center font-medium text-gray-700">
                                @day
                            </td>
                            @foreach (var period in periods)
                            {
                                <td class="border border-gray-300 p-1 align-top">
                                    @{
                                        var schedules = GetSchedulesForPeriod(day, period.Start, period.End);
                                        foreach (var schedule in schedules)
                                        {
                                            <div class="rounded-md bg-indigo-100 border border-indigo-200 p-1 mb-1 text-xs">
                                                <div class="font-medium text-indigo-700">@schedule.CourseName</div>
                                                <div class="text-indigo-600">@schedule.GradeLevel ห้อง @schedule.ClassNumber</div>
                                                <div class="text-gray-500 text-xs">
                                                    @FormatTimeDisplay(schedule.StartTime) - @FormatTimeDisplay(schedule.EndTime)
                                                </div>
                                            </div>
                                        }
                                    }
                                </td>
                            }
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- รายการตารางสอนทั้งหมด -->
        <div class="bg-white rounded-lg shadow p-4">
            <h3 class="text-lg font-medium text-gray-700 mb-4">รายการตารางสอนทั้งหมด</h3>
            <div class="overflow-x-auto">
                <table class="min-w-full border border-collapse border-gray-300">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 border border-gray-300 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">รายวิชา</th>
                            <th class="px-4 py-3 border border-gray-300 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ชั้นเรียน</th>
                            <th class="px-4 py-3 border border-gray-300 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ห้อง</th>
                            <th class="px-4 py-3 border border-gray-300 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">วัน</th>
                            <th class="px-4 py-3 border border-gray-300 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">เวลา</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model == null || !Model.Any())
                        {
                            <tr>
                                <td colspan="5" class="px-4 py-4 border border-gray-300 text-center text-sm text-gray-500">ไม่พบตารางสอน</td>
                            </tr>
                        }
                        else
                        {
                            @foreach (var item in Model)
                            {
                                <tr>
                                    <td class="px-4 py-3 border border-gray-300 text-sm text-gray-900">@item.CourseName</td>
                                    <td class="px-4 py-3 border border-gray-300 text-sm text-gray-900">@item.GradeLevel</td>
                                    <td class="px-4 py-3 border border-gray-300 text-sm text-gray-900">@item.ClassNumber</td>
                                    <td class="px-4 py-3 border border-gray-300 text-sm text-gray-900">@item.DayOfWeek</td>
                                    <td class="px-4 py-3 border border-gray-300 text-sm text-gray-900">
                                        @FormatTimeDisplay(item.StartTime) - @FormatTimeDisplay(item.EndTime)
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>